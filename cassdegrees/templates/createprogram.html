{% extends "base.html" %}
{% load static %}

{% block page-title %}Create Program Template{% endblock %}

{% block subtitle %}Create Program Template{% endblock %}

{% block content %}
    {% if msg != None %}
        <p class="{% if is_error %}msg-error{% else %}msg-success{% endif %}" id="serverError">{{ msg }}</p>
    {% endif %}


    <form class="anuform" id="mainForm" action="" novalidate method="post">
        {% csrf_token %}

        <fieldset>
            <legend>Configure Program Details</legend>

            <p class="form-group">
                <label for="code">Program Code:</label>
                <input class="text" id="code" type="text" name="code" aria-required="true" minlength="4" placeholder="e.g. BARTS" required value="{{ code|default:"" }}">
            </p>

            <p class="form-group">
                <label for="name">Program Name:</label>
                <input class="text" id="name" type="text" name="name" aria-required="true" minlength="5" placeholder="e.g. Bachelor of Arts" required value="{{ name|default:"" }}">
            </p>

            <p class="form-group">
                <label for="year">Program Year:</label>
                <input class="text" id="year" type="number" min="2000" max="2100" value="{{ year|default:"2019" }}" name="year" aria-required="true" required>
            </p>

            <p class="form-group">
                <label for="units">Program Units:</label>
                <input class="text" id="units" type="number" min="0" max="1000" value="{{ units|default:"144" }}" name="units" aria-required="true" required>
            </p>

            <p class="form-group">
                <label for="degreeType">Program Type:</label>
                <select id="degreeType" name="degreeType" aria-required="true" required>
                    <option value="ugrad-sing" {% if degreeType == "ugrad-sing" or degreeType == None %}selected{% endif %}>Undergraduate Single Pass Degree</option>
                    <option value="ugrad-doub" {% if degreeType == "ugrad-doub" %}selected{% endif %}>Undergraduate Flexible Double Degree</option>
                    <option value="hon" {% if degreeType == "hon" %}selected{% endif %}>Honours Degree</option>
                    <option value="mast-sing" {% if degreeType == "mast-sing" %}selected{% endif %}>Masters Single Degree</option>
                    <option value="mast-adv" {% if degreeType == "mast-adv" %}selected{% endif %}>Masters (Advanced) Degree</option>
                    <option value="mast-doub" {% if degreeType == "mast-doub" %}selected{% endif %}>Masters Flexible Double Degree</option>
                    <option value="vert-doub" {% if degreeType == "vert-doub" %}selected{% endif %}>Vertical Flexible Double Degree</option>
                </select>
            </p>
        </fieldset>

        <!-- Everything after here is generated on the fly -->
        <input class="text" hidden id="globalRequirements" name="globalRequirements">
        <input class="text" hidden id="rules" name="rules">
    </form>

    <!-- We still need a form for regular styling, though these will be serialized manually because of their list-like
         structure -->
    <form class="anuform" id="manualSerializedForm" novalidate>
        <fieldset>
            <legend>Add Global Requirements</legend>

            <br />

            <div id="globalRequirementsContainer">

            </div>

            <input class="btn-uni-grad btn-large" type="button" onclick="addGlobalReq()" value="Add New Global Requirement" />
        </fieldset>

        <fieldset>
            <legend>Add Rules</legend>

            <br />

            <rule_container v-bind:rules="rules" />
        </fieldset>
    </form>

    <p class="text-right">
        <input class="btn-uni-grad btn-large" type="submit" value="Create" onclick="submitProgram()">
    </p>

    <!-- Acts as a master template for duplication, preventing inline HTML in Javascript. -->
    <div id="minMaxUnitsTemplate" style="display: none">
        <fieldset>
            <legend></legend>

            <p class="form-group">
                <label>
                    Unit Count:
                </label>
                <input class="text" type="number" name="unit_count" min="0" max="1000" value="48" aria-required="true" required>
            </p>

            <p>
                <label>
                    Year Options:
                </label>
            </p>

            <br />

            <table class="tbl-row-bdr">
                <thead>
                    <tr>
                        <th>
                            1000-level
                        </th>
                        <th>
                            2000-level
                        </th>
                        <th>
                            3000-level
                        </th>
                        <th>
                            4000-level
                        </th>
                        <th>
                            5000-level
                        </th>
                        <th>
                            6000-level
                        </th>
                        <th>
                            7000-level
                        </th>
                        <th>
                            8000-level
                        </th>
                        <th>
                            9000-level
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <input type="checkbox" name="courses1000Level">
                        </td>
                        <td>
                            <input type="checkbox" name="courses2000Level">
                        </td>
                        <td>
                            <input type="checkbox" name="courses3000Level">
                        </td>
                        <td>
                            <input type="checkbox" name="courses4000Level">
                        </td>
                        <td>
                            <input type="checkbox" name="courses5000Level">
                        </td>
                        <td>
                            <input type="checkbox" name="courses6000Level">
                        </td>
                        <td>
                            <input type="checkbox" name="courses7000Level">
                        </td>
                        <td>
                            <input type="checkbox" name="courses8000Level">
                        </td>
                        <td>
                            <input type="checkbox" name="courses9000Level">
                        </td>
                    </tr>
                </tbody>
            </table>
        </fieldset>

    </div>

    <div id="globalReqsTemplate" style="display: none">
        <div class="box-header">
            Global Requirement

            <input class="btn-uni-grad btn-snall no-left-margin" type="button" onclick="removeGlobalReq(this)" value="Remove" />
        </div>

        <div class="box-solid">
            <fieldset>
                <p class="form-group">
                    <label for="ruleType">
                        Rule Type:
                    </label>

                    <select name="ruleType" aria-required="true" required id="globalReqsTypePlaceholder" onchange="onGlobalReqsTypeChanged(this)">
                        <!-- https://stackoverflow.com/questions/5805059/how-do-i-make-a-placeholder-for-a-select-box -->
                        <option value="" disabled selected>Select...</option>
                        <option value="min">Minimum Units From Year(s)</option>
                        <option value="max">Maximum Units From Year(s)</option>
                    </select>
                </p>

                <hr />

                <!-- Placeholder for min/max templates to be injected -->
                <div id="globalReqsInnerPlaceholder"></div>

            </fieldset>
        </div>
    </div>

    {% verbatim %}
    <script type="text/x-template" id="subplanRuleTemplate">
        <fieldset v-if="!redraw">
            <div class="msg-error" v-if="non_unique_options">Options must be unique!</div>

            <p>
                Students must pick one from the following:
            </p>

            <div v-for="(id, index) in details.ids">
                <select v-model="details.ids[index]" v-on:change="check_options()" required>
                    <option v-for="subplan in subplans" v-bind:value="subplan.id">{{ subplan.name }} ({{ subplan.units }} units)</option>
                </select>
                <input v-if="index != 0" type="button" v-on:click="remove_subplan(index)" class="btn-uni-grad btn-snall no-left-margin" value="Remove" />
            </div>

            <input type="button" v-on:click="add_subplan()" class="btn-uni-grad btn-snall no-left-margin" value="Add new option" />
        </fieldset>
    </script>

    <script type="text/x-template" id="customTextRuleTemplate">
        <fieldset>
            <p>
                Students must complete the following:
            </p>

            <p>
                <textarea v-model="details.text" style="width: 100%" placeholder="Enter some custom rules here..." aria-required="true" required></textarea>
            </p>

            <p class="form-group">
                <label>Unit value for this item:</label>
                <input class="text" type="number" min="0" max="1000" v-model="details.units" aria-required="true" required>
            </p>

            <div class="msg-error" v-if="not_divisible">Units must be divisible by 6!</div>
        </fieldset>
    </script>

    <script type="text/x-template" id="ruleTemplate">
        <div class="card">
            <header class="box-header">
                <a href="#" class="card-header-icon">
                    <span class="icon">
                        <i class="fas fa-grip-vertical"></i>
                    </span>
                </a>
                <p class="card-header-title">
                    {{ component_names[details.type] }}
                </p>
                <input type="button" v-on:click="$emit('remove')" class="btn-uni-grad btn-snall no-left-margin" value="Remove" />
            </header>
            <div class="box-solid">
                <div class="card-content" v-bind:is="'rule_' + details.type" v-bind:details="details"></div>
            </div>
        </div>
    </script>

    <script type="text/x-template" id="ruleContainerTemplate">
        <div v-if="!redraw">
            <div v-for="(item, index) in rules" :key="index" >
                <rule class="rule-container" v-bind:details="item" v-on:update="update(index, $event)" v-on:remove="remove(index)"></rule>
                <div v-if="index < rules.length - 1 && separator.length > 0">{{ separator }}<br /><br /></div>
            </div>

            <input class="btn-uni-grad btn-large no-left-margin" type="button" v-on:click="show_add_a_rule_modal = true" value="Add New Rule" />

            <div class="modal" v-if="show_add_a_rule_modal">
                <div class="modal-background" v-on:click="show_add_a_rule_modal = false"></div>
                <div class="modal-card">
                    <div class="card">
                        <header class="box-header">
                            Add a rule...
                        </header>
                        <div class="box-solid box-has-footer">
                            <p>Select a kind of rule to add:</p>
                            <div class="select">
                                <select v-model="add_a_rule_modal_option">
                                    <option v-for="(option, index) in component_names" v-bind:value="index">
                                        {{ option }}
                                    </option>
                                </select>
                            </div>
                        </div>
                        <footer class="box-solid">
                            <button class="button is-success" v-on:click="add_rule">Add</button>
                            <button class="button" v-on:click="show_add_a_rule_modal = false">Cancel</button>
                        </footer>
                    </div>
                </div>
            </div>
        </div>
    </script>
    {% endverbatim %}

    <script src="{% static 'js/vue.js' %}" type="application/javascript"></script>
    <script src="{% static 'js/pristine.js' %}" type="application/javascript"></script>
    <script src="{% static 'js/programmanagement.js' %}" type="application/javascript"></script>
    <script src="{% static 'js/rules.js' %}" type="application/javascript"></script>

    {% if globalRequirements != None %}
        <script>
            deserializeReqs({{ globalRequirements|safe }});
        </script>
    {% endif %}
    {% if rules != None %}
        <script>
            app.rules = {{ rules|safe }};
        </script>
    {% endif %}
{% endblock %}
