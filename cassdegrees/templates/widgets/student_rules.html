{% load student_course_boxes %}
{% load math %}

{# Renders rule a rule for a student plan #}
<div class="card">
    {% if rule.type == "subplan" %}
        <p>Completion of {{ rule.kind }} for {{ rule.units }} units:</p>
    {% elif rule.type == "subject_area" %}
        {# https://stackoverflow.com/questions/4831306/need-to-convert-a-string-to-int-in-a-django-template #}
        {# add:"0" needed to cast units to int #}
        <p>Complete {{ rule.unit_count }} units from {% if rule.unit_count|add:"0" <= 6 %}a{% endif %}
            {{ rule.subject }} course{% if rule.unit_count|add:"0" > 6 %}s{% endif %}:</p>
    {% elif rule.type == "year_level" %}
        <p>Complete {{ rule.unit_count }} units from {% if rule.unit_count|add:"0" <= 6 %}a{% endif %}
            {{ rule.year_level }}-level course{% if rule.unit_count|add:"0" > 6 %}s{% endif %}:</p>
    {% elif rule.type == "course" %}
        {# Find out if all courses are required #}
        {% with courses_provided=rule.codes|length %}
            {% with courses_needed=rule.unit_count|divide:6 %}
                {% if courses_provided == courses_needed %}
                    {# All courses specified are required - render all #}
                    <p>Complete {{ rule.unit_count }} units from the following
                        {% if rule.unit_count|add:"0" <= 6 %}course{% else %}set of courses{% endif %}:</p>
                {% else %}
                    {# Not all required courses - give descriptions #}
                    <p>Complete {{ rule.unit_count }} units from a selection of:</p>
                    {% for code in rule.codes %}
                        {{ code }}{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                {% endif %}
            {% endwith %}
        {% endwith %}
    {% elif rule.type == "either_or" %}
        <p class="bottom-margin">Either:</p>

        {% for group in rule.either_or %}
            <div class="left-box" style="padding-left: 40px;">
                {% for rule in group %}
                    {% include "widgets/student_rules.html" %}
                {% endfor %}
            </div>

            {% if not forloop.last %}<p class="bottom-margin top-margin">or...</p>{% endif %}
        {% endfor %}
    {% elif rule.type == "custom_text" %}
        <p>For {{ rule.units }} units:</p>
        <p>{{ rule.text }}</p>
    {% else %}
        ERROR: Unknown rule type "{{ rule.type }}"!
    {% endif %}
</div>

<div style="padding-left: 20px;">
    {% if rule.type == "subplan" %}
        {# Assume all subplans have equal units - else it wouldn't make sense for a complete program #}
        {% with subplan=subplans|index:rule.ids.0 %}
            {% student_course_box subplan.units %}
        {%  endwith %}
    {% elif rule.type == "subject_area" %}
        {% student_course_box rule.unit_count %}
    {% elif rule.type == "year_level" %}
        {% student_course_box rule.unit_count %}
    {% elif rule.type == "course" %}
        {% with courses_provided=rule.codes|length %}
            {% with courses_needed=rule.unit_count|divide:6 %}
                {% if courses_provided == courses_needed %}
                    {# All courses specified are required - render all #}
                    {% student_course_box_with_values rule.unit_count rule.codes %}
                {% else %}
                    {# Not all required courses - map them out as blanks #}
                    {% student_course_box rule.unit_count %}
                {% endif %}
            {% endwith %}
        {% endwith %}
    {% elif rule.type == "custom_text" %}
        {% if rule.show_course_boxes %}
            {% student_course_box rule.units %}
        {% endif %}
    {% endif %}
</div>
